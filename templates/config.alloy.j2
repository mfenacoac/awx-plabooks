logging {
  level = "info"
}

############################
# Windows Exporter
############################
prometheus.exporter.windows "default" {
  enabled_collectors = [
    "cpu", "cs", "logical_disk", "net", "os",
    "system", "cpu_info", "memory", "time",
  ]
}

############################
# Windows Event Logs
############################
loki.source.windowsevent "application" {
  eventlog_name = "Application"
  forward_to    = [loki.write.endpoint.receiver]
}

############################
# JBoss Logs (din√°mico)
############################
{% for jboss in jboss_instances %}
local.file_match "{{ jboss.name }}_files" {
  "__path__"    = "{{ jboss.log_path | replace('\\', '/') }}"
  sync_period  = "5s"
}

loki.source.file "{{ jboss.name }}_scrape" {
  targets        = local.file_match.{{ jboss.name }}_files.targets
  tail_from_end  = true
  forward_to     = [loki.process.{{ jboss.name }}_processor.receiver]
}

loki.process "{{ jboss.name }}_processor" {

  stage.regex {
    expression = ".*span_id=(?P<span_id>[a-f0-9]{16}).*trace_id=(?P<trace_id>[a-f0-9]{32}).*"
  }

  stage.labels {
    values = {
      trace_id = ""
      span_id  = ""
    }
  }

  stage.static_labels {
    values = {
      job            = "JBOSS_APPL"
      service_name   = "JBOSS-APPL"
      environment    = "{{ environment }}"
      hostname       = sys.env("COMPUTERNAME")
      instance       = "{{ ansible_host }}"
      jboss_instance = "{{ jboss.name }}"
      client         = "{{ client }}"
    }
  }

  forward_to = [loki.write.endpoint.receiver]
}
{% endfor %}

############################
# Loki Endpoint
############################
loki.write "endpoint" {
  endpoint {
    url = "{{ loki_url }}"
  }
}
